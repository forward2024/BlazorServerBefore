@page "/editproduct/{Id:int}"
@inject BlazorService BlazorService
@inject NavigationManager NavigationManager
@inject IProduct ProductService

<h3 class="page-title">Редагувати товар</h3>

<div class="grid-container">
    <div class="form-section">
        <h4 class="form-section-title">Основні дані</h4>

        <EditForm Model="@product" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="name">Назва:</label>
                <InputText id="name" @bind-Value="product.Name" class="form-control" />
            </div>

            <div class="form-group">
                <label for="description">Опис:</label>
                <InputTextArea id="description" @bind-Value="product.Description" class="form-control" />
            </div>

            <div class="form-group">
                <label for="price">Ціна:</label>
                <InputNumber id="price" @bind-Value="product.Price" class="form-control" />
            </div>

            <div class="form-group">
                <label for="action">Акція:</label>
                <InputNumber id="action" @bind-Value="product.Action" class="form-control" />
            </div>

            <div class="form-group">
                <label for="categoryId">Категорія:</label>
                <InputSelect id="categoryId" @bind-Value="product.CategoryId" class="form-control" @key="BlazorService.Categories">
                    @foreach (var category in BlazorService.Categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                </InputSelect>
            </div>

            <div class="form-group">
                <label for="sellerId">Продавець:</label>
                <InputSelect id="sellerId" @bind-Value="product.SellerId" class="form-control" @key="BlazorService.Sellers">
                    @foreach (var seller in BlazorService.Sellers)
                    {
                        <option value="@seller.Id">@seller.Name</option>
                    }
                </InputSelect>
            </div>

            <div class="form-group">
                <label for="typeItemId">Тип товару:</label>
                <InputSelect id="typeItemId" @bind-Value="product.TypeItemId" class="form-control" @key="BlazorService.TypeItems">
                    @foreach (var typeItem in BlazorService.TypeItems)
                    {
                        <option value="@typeItem.Id">@typeItem.Name</option>
                    }
                </InputSelect>
            </div>

            @if (product.Seasons.Any())
            {
                <div class="form-group">
                    <label>Сезони</label>
                    <ul>
                        @foreach (var season in product.Seasons)
                        {
                            <li>
                                @season
                                <button type="button" class="btn btn-danger" @onclick="() => RemoveSeason(season)">Видалити</button>
                            </li>
                        }
                    </ul>
                </div>
            }

            <div class="form-group">
                <button type="button" class="btn btn-primary" @onclick="ShowSeasonModal">Додати сезон</button>
                <AddSeasonModel @ref="addSeasonModel" OnSeason="@OnSeasonAddedHandler" />
            </div>

            @if (product.Sizes.Any())
            {
                <div class="form-group">
                    <label>Розміри:</label>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Розмір</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var size in product.Sizes)
                            {
                                <tr>
                                    <td>@size</td>
                                    <td><button type="button" class="btn btn-danger" @onclick="() => RemoveSize(size)">Видалити</button></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            <div class="form-group">
                <button type="button" class="btn btn-primary" @onclick="ShowSizeModal">Додати розмір</button>
                <AddSizeModel @ref="addSizeModel" OnSize="@OnSizeAddedHandler" />
            </div>

            @if (showMessage)
            {
                <div class="alert alert-info" role="alert">
                    @message
                </div>
            }
            <button type="submit" class="btn btn-primary">Зберегти зміни</button>
        </EditForm>
    </div>

    <div class="image-management-section">
        <h4 class="form-section-title">Керування зображеннями</h4>
        <ImageManagement CurrentProduct="product" />
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    Product product = new();
    private AddSizeModel addSizeModel;
    private AddSeasonModel addSeasonModel;
    string? message;
    bool showMessage = false;

    protected override async Task OnInitializedAsync()
    {
        product = await ProductService.GetProductByIdAsync(Id);
    }


    private void ShowSizeModal()
    {
        addSizeModel.ToggleModal();
    }
    private void ShowSeasonModal()
    {
        addSeasonModel.ToggleModal();
    }


    private async Task OnSizeAddedHandler(string size)
    {
        product.Sizes.Add(size);
    }
    private async Task OnSeasonAddedHandler(string season)
    {
        product.Seasons.Add(season);
    }


    private void RemoveSeason(string season)
    {
        product.Seasons.Remove(season);
    }
    private void RemoveSize(string size)
    {
        product.Sizes.Remove(size);
    }

    private async Task HandleValidSubmit()
    {
        if (await ProductService.UpdateProductAsync(product))
        {
            NavigationManager.NavigateTo("/ControlPanel");
        }
        else
        {
            message = "Змін не має";
            showMessage = !showMessage;
            StateHasChanged();

            await Task.Delay(2000);

            showMessage = !showMessage;
            StateHasChanged();

        }
    }
}

